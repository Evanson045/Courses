{% extends "base.html" %}
{% block title %}{{ chapter.title }}{% endblock %}
{% block content %}
<div class="container mt-5">
  <!-- Chapter Section -->
  <div class="module-section p-4 shadow-lg rounded" 
       style="background-color:#002b36; color:#d6e1e9; border:none;">
    <h2 class="fw-bold text-center" style="color:#ffd700;">{{ chapter.title }}</h2>
    <p class="module-tagline text-center mt-3 mb-4 p-2 rounded" 
       style="background-color:#d6e1e9; color:#002b36;">
      {{ chapter.description }}
    </p>
    <hr style="border-color:#ffd700;">

    {% if user and (user.is_subscribed or chapter.id <= 5) %}
      {% if chapter.content %}
        <div class="module-content mt-3">
          {{ chapter.content|safe }}
        </div>
      {% endif %}
    {% else %}
      <div class="locked-message text-center mt-4">
        <p class="fw-bold" style="color:#ffd700;">
          üîí This chapter is locked. Please unlock all to continue.
        </p>
        {% if not user or not user.is_subscribed %}
          <button class="btn fw-semibold transition-btn unlock-btn" 
                  style="background-color:#ffd700; color:#002b36; border-radius:8px;" 
                  data-bs-toggle="modal" data-bs-target="#paypalUnlockAllModal">
            Unlock Chapters (USD 25)
          </button>
          <p class="text-center mt-2" style="color:#d6e1e9;">
            üîê Secure checkout via PayPal. One-time payment, lifetime access.
          </p>
        {% else %}
          <div class="alert alert-success mt-3 fw-semibold">
            ‚úÖ You already have access to all chapters.
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Navigation Buttons -->
<div class="container mt-4 d-flex justify-content-between align-items-center nav-buttons">
  <a href="{{ url_for('show_course', course_name=course_name) }}" 
     class="btn fw-semibold transition-btn" 
     style="background-color:#ffd700; color:#000000; border-radius:8px;">
    ‚Üê Course Overview
  </a>
  <div class="ms-auto">
    {% if chapter.id > 1 %}
      <a href="{{ url_for('show_chapter', course_name=course_name, chapter_id=chapter.id - 1) }}" 
         class="btn me-2 fw-semibold transition-btn" 
         style="background-color:#1496b6; color:#000000; border-radius:8px;">
        ‚Üê Previous
      </a>
    {% endif %}
    {% if chapter.id < chapter_list|length %}
      <a href="{{ url_for('show_chapter', course_name=course_name, chapter_id=chapter.id + 1) }}" 
         class="btn fw-semibold transition-btn" 
         style="background-color:#0d8b1e; color:#ffffff; border-radius:8px;">
        Next ‚Üí
      </a>
    {% endif %}
  </div>
</div>

<!-- Unlock Modal -->
<div class="modal fade" id="paypalUnlockAllModal" tabindex="-1" aria-labelledby="paypalUnlockAllModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-lg" style="background-color:#002b36; color:#d6e1e9;">
      <div class="modal-header">
        <h5 class="modal-title" id="paypalUnlockAllModalLabel" style="color:#ffd700;">Unlock All Chapters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        {% if not user or not user.is_subscribed %}
          <p class="fw-bold mb-3" style="color:#ffd700;">
            To unlock all please pay <strong>USD 25</strong> via PayPal.
          </p>
          <!-- PayPal button container -->
          <div id="paypal-all-button-container" class="mt-2"></div>
          <p class="mt-3" style="color:#d6e1e9; font-size:0.95rem;">
            üîê Secure checkout via PayPal. We never store your card details.
          </p>
        {% else %}
          <div class="alert alert-success fw-semibold">
            ‚úÖ You already have access to all courses.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<!-- PayPal SDK Script -->
<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById('paypal-all-button-container');
    if (container) {
      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              description: "Unlock All Courses",
              amount: { value: '25.00', currency_code: 'USD' }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            fetch("/paypal-success", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ orderID: data.orderID })
            }).then(response => response.json())
              .then(result => {
                if (result.status === "ok") {
                  document.querySelectorAll(".unlock-btn").forEach(btn => {
                    btn.outerHTML = `
                      <a href="{{ url_for('dashboard') }}" class="btn btn-success">Open Chapter</a>
                    `;
                  });
                  const modal = bootstrap.Modal.getInstance(document.getElementById('paypalUnlockAllModal'));
                  if (modal) modal.hide();
                } else {
                  alert("Payment verification failed: " + (result.error || "Unknown error"));
                }
              })
              .catch(() => alert("Network error. Please try again."));
          });
        },
        onError: function(err) {
          console.error("PayPal error:", err);
          alert("Something went wrong with PayPal. Please try again.");
        }
      }).render('#paypal-all-button-container');
    }
  });
</script>
{% endblock %}

<!-- Hover Effects CSS -->
<style>
  .transition-btn {
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
  }
  .transition-btn:hover {
    background-color:#d6e1e9 !important;
    color:#002b36 !important;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
  }
  .nav-buttons a { transition: transform 0.3s ease, box-shadow 0.3s ease; }
  .nav-buttons a:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
</style>
{% endblock %}
