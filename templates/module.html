{% extends "base.html" %}
{% block title %}{{ module.title }}{% endblock %}
{% block content %}
<div class="container mt-5">
  <!-- Module Section -->
  <div class="module-section p-4 shadow-sm">
    <h2 class="fw-bold text-center">{{ module.title }}</h2>
    <p class="module-tagline text-center mt-3 mb-4 bg-white p-2 rounded">
      {{ module.description }}
    </p>
    <hr>

    {% if user and (user.is_subscribed or module.id <= 5) %}
      <!-- Show content for free modules or subscribed users -->
      {% if module.content %}
        <div class="module-content mt-3">
          {{ module.content|safe }}
        </div>
      {% endif %}
    {% else %}
      <!-- Locked modules (6‚Äì15) for non‚Äësubscribed users -->
      <div class="locked-message text-center mt-4">
        <p class="fw-bold text-warning">
          üîí This module is locked. Please unlock all modules to continue.
        </p>
        <button class="btn btn-warning fw-semibold" data-bs-toggle="modal" data-bs-target="#paypalUnlockAllModal">
          Unlock Modules (KES 2500)
        </button>
      </div>
    {% endif %}
  </div>
</div>

<!-- Navigation Buttons -->
<div class="container mt-4 d-flex justify-content-between align-items-center nav-buttons">
  <!-- Back to Course -->
  <a href="{{ url_for('course_detail', course_name=course_name) }}" class="btn btn-warning fw-semibold">
    ‚Üê Back to Course
  </a>
  <div class="ms-auto">
    {% if module.id > 1 %}
      <a href="{{ url_for('show_module', course_name=course_name, id=module.id - 1) }}" class="btn btn-primary me-2 fw-semibold">
        ‚Üê Previous
      </a>
    {% endif %}
    {% if module.id < course.modules|length %}
      <a href="{{ url_for('show_module', course_name=course_name, id=module.id + 1) }}" class="btn btn-primary fw-semibold">
        Next ‚Üí
      </a>
    {% endif %}
  </div>
</div>

<!-- Unlock Modal -->
<div class="modal fade" id="paypalUnlockAllModal" tabindex="-1" aria-labelledby="paypalUnlockAllModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="paypalUnlockAllModalLabel">Unlock All Modules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p class="fw-bold text-warning mb-3">
          To unlock modules 6‚Äì15, please pay <strong>KES 2500</strong> via PayPal.
        </p>
        <div id="paypal-all-button-container" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- PayPal SDK Script -->
<script src="https://www.paypal.com/sdk/js?client-id=AUvxeWZl_Jhm4R0bJ4AAE5RcEE8074-jcEHw81Vd4qMncGa5ABA15ZPHCrSHRfZkzohWmq0nrKljNrqv&currency=USD"></script>
<script>
  paypal.Buttons({
    style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          description: "Unlock All Modules",
          amount: { value: '25.00' } // USD equivalent of KES 2500
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        fetch("/paypal-success", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderID: data.orderID })
        }).then(() => {
          window.location.href = "{{ url_for('dashboard') }}";
        });
      });
    }
  }).render('#paypal-all-button-container');
</script>
{% endblock %}
