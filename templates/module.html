{% extends "base.html" %}
{% block title %}{{ module.title }}{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="module-section p-4">
    <h2 class="fw-bold text-center">{{ module.title }}</h2>
    <hr>
    <p class="module-description text-white text-center">{{ module.description }}</p>
    {% if module.content %}
      <div class="module-content mt-3">
        {{ module.content|safe }}
      </div>
    {% endif %}
  </div>
</div>

<!-- Navigation buttons -->
<div class="mt-4 d-flex justify-content-between align-items-center">
  <!-- Back to Course always visible -->
  <a href="{{ url_for('course_detail', course_name=course_name) }}" class="btn btn-secondary">
    ‚Üê Back to Course
  </a>

  <div class="ms-auto">
    {% if module.id > 1 %}
      <!-- Previous module -->
      <a href="{{ url_for('module', course_name=course_name, id=module.id - 1) }}" class="btn btn-outline-light me-2">
        ‚Üê Previous
      </a>
    {% endif %}
    {% if module.id < course.modules|length %}
      <!-- Next module -->
      <a href="{{ url_for('module', course_name=course_name, id=module.id + 1) }}" class="btn btn-outline-light">
        Next ‚Üí
      </a>
    {% endif %}
  </div>
</div>

{% if not user.is_subscribed %}
<!-- PayPal Unlock Modal (Single Module) -->
<div class="modal fade" id="paypalUnlockModal" tabindex="-1" aria-labelledby="paypalUnlockModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="paypalUnlockModalLabel">Unlock Module</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>To unlock this module, please pay <strong>KES 500</strong> via PayPal.</p>
        <!-- PayPal Branded Button -->
        <div id="paypal-button-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- PayPal Unlock Modal (All Modules) -->
<div class="modal fade" id="paypalUnlockAllModal" tabindex="-1" aria-labelledby="paypalUnlockAllModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="paypalUnlockAllModalLabel">Unlock All Modules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Unlock <strong>all modules</strong> for <strong>KES 2000</strong> via PayPal.</p>
        <!-- PayPal Branded Button -->
        <div id="paypal-all-button-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- Trigger Buttons -->
<div class="container mt-3">
  <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#paypalUnlockModal">
    Unlock This Module
  </button>
  <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#paypalUnlockAllModal">
    Unlock All Modules
  </button>
</div>

<!-- PayPal SDK Script -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD"></script>
<script>
  // Single Module Payment
  paypal.Buttons({
    style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          description: "Unlock Single Module",
          amount: { value: '5.00' } // USD equivalent of KES 500
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert("Payment completed by " + details.payer.name.given_name + "! üéâ");
        window.location.href = "{{ url_for('unlock_module') }}";
      });
    },
    onError: function(err) {
      console.error(err);
      alert("An error occurred during payment. Please try again.");
    }
  }).render('#paypal-button-container');

  // Unlock All Payment
  paypal.Buttons({
    style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          description: "Unlock All Modules",
          amount: { value: '20.00' } // USD equivalent of KES 2000
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert("Payment completed by " + details.payer.name.given_name + "! üéâ");
        window.location.href = "{{ url_for('unlock_all') }}";
      });
    },
    onError: function(err) {
      console.error(err);
      alert("An error occurred during payment. Please try again.");
    }
  }).render('#paypal-all-button-container');
</script>
{% endif %}
{% endblock %}
