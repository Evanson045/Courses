{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}
  <!-- Hero Section -->
  <div class="hero text-center mb-5">
    <h1>{{ course.icon }} {{ course.title }}</h1>
    <p class="lead">{{ course.description }}</p>
  </div>

  <!-- Course Overview -->
  <div class="container mb-4">
    <h3>Course Overview</h3>
    {% if course.overview %}
      <p>{{ course.overview }}</p>
    {% else %}
      <p class="text-muted">No overview available for this course.</p>
    {% endif %}
  </div>

  <!-- Modules Grid -->
  <div class="container mt-4 mb-5">
    <div class="row">
      {% for module in course.modules %}
        <div class="col-12 mb-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h5 class="card-title mb-2">Module {{ loop.index }}: {{ module.title }}</h5>
                <p class="card-text">{{ module.description }}</p>
              </div>
              <div>
                {% if user.is_subscribed or module.free %}
                  <a href="{{ url_for('module', course_name=course_name, id=module.id) }}" class="btn btn-primary w-100">
                    Open
                  </a>
                {% else %}
                  <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#paypalModuleModal" data-module="{{ module.id }}">
                    Unlock Module
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Sticky Progress Indicator at Bottom -->
  <div class="fixed-bottom bg-dark text-white text-center py-3 shadow-lg">
    {% set unlocked = 15 if user.is_subscribed else 5 %}
    <div class="d-flex justify-content-between align-items-center container">
      <div>
        {% if user.is_subscribed %}
          âœ… All 15 modules unlocked
        {% else %}
          ðŸ”“ Free access: 5/15 modules unlocked
        {% endif %}
      </div>
      {% if not user.is_subscribed %}
        <button class="btn btn-warning btn-sm ms-3" data-bs-toggle="modal" data-bs-target="#paypalUnlockAllModal">
          ðŸ”“ Unlock All (KES 2500)
        </button>
      {% endif %}
    </div>
    <div class="progress mt-2" style="height: 20px;">
      <div class="progress-bar bg-success" role="progressbar"
           style="width: {{ ((unlocked / 15) * 100)|round(2) }}%;"
           aria-valuenow="{{ unlocked }}" aria-valuemin="0" aria-valuemax="15">
        {{ unlocked }}/15 Modules
      </div>
    </div>
  </div>

  <!-- Unlock Single Module Modal -->
  <div class="modal fade" id="paypalModuleModal" tabindex="-1" aria-labelledby="paypalModuleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title" id="paypalModuleModalLabel">Unlock Module</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p class="fw-bold text-warning mb-3">
            To unlock this module, please pay <strong>KES 500</strong> via PayPal.
          </p>
          <div id="paypal-single-button-container" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unlock All Modules Modal -->
  <div class="modal fade" id="paypalUnlockAllModal" tabindex="-1" aria-labelledby="paypalUnlockAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title" id="paypalUnlockAllModalLabel">Unlock All Modules</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p class="fw-bold text-warning mb-3">
            To unlock all modules in this course, please pay <strong>KES 2500</strong> via PayPal.
          </p>
          <div id="paypal-all-button-container" class="mt-2"></div>
          <hr>
          <div id="paypal-subscription-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PayPal SDK Script -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&vault=true&intent=subscription&currency=USD"></script>
  <script>
    // Single Module Payment
    paypal.Buttons({
      style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            description: "Unlock Single Module",
            amount: { value: '5.00' } // USD equivalent of KES 500
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          alert("Payment completed by " + details.payer.name.given_name + "! ðŸŽ‰");
          window.location.href = "{{ url_for('unlock_module') }}";
        });
      },
      onError: function(err) {
        console.error("Single Module Payment Error:", err);
        alert("An error occurred during payment. Please try again.");
      }
    }).render('#paypal-single-button-container');

    // Unlock All Payment
    paypal.Buttons({
      style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            description: "Unlock All Modules",
            amount: { value: '25.00' } // USD equivalent of KES 2500
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          alert("Payment completed by " + details.payer.name.given_name + "! ðŸŽ‰");
          window.location.href = "{{ url_for('unlock_all') }}";
        });
      },
      onError: function(err) {
        console.error("Unlock All Payment Error:", err);
        alert("An error occurred during payment. Please try again.");
      }
    }).render('#paypal-all-button-container');

    // Subscription Payment
    paypal.Buttons({
      createSubscription: function(data, actions) {
        return actions.subscription.create({
          plan_id: 'YOUR_PLAN_ID'
        });
      },
      onApprove: function(data, actions) {
        alert('Subscription successful! ID: ' + data.subscriptionID);
        window.location.href = "{{ url_for('unlock_all') }}";
      },
      onError: function(err) {
        console.error("Subscription Error:", err);
        alert("An error occurred during subscription. Please try again.");
      }
    }).render('#paypal-subscription-container');
  </script>
{% endblock %}
