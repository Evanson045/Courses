{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}
  <!-- Hero Section -->
  <div class="hero text-center mb-5">
    <h1>{{ course.icon }} {{ course.title }}</h1>
    <p class="lead">{{ course.description }}</p>
  </div>

  <!-- Course Overview -->
  <div class="container mb-4">
    <h3>Course Overview</h3>
    <p>{{ course.overview }}</p>
  </div>

  <!-- Progress Indicator -->
  <div class="container mb-4">
    {% set unlocked = 15 if user.is_subscribed else 5 %}
    <div class="alert alert-info text-center mb-3 d-flex justify-content-between align-items-center">
      <div>
        {% if user.is_subscribed %}
          âœ… All 15 modules unlocked
        {% else %}
          ðŸ”“ Free access: 5/15 modules unlocked
        {% endif %}
      </div>
      {% if not user.is_subscribed %}
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#paypalUnlockAllModal">
          Unlock All (KES 2500)
        </button>
      {% endif %}
    </div>

    <div class="progress" style="height: 25px;">
      <div class="progress-bar bg-success" role="progressbar"
           style="width: {{ (unlocked / 15) * 100 }}%;"
           aria-valuenow="{{ unlocked }}" aria-valuemin="0" aria-valuemax="15">
        {{ unlocked }}/15 Modules
      </div>
    </div>
  </div>

  <!-- Modules Grid -->
  <div class="container mt-4">
    <div class="row">
      {% for module in course.modules %}
        <div class="col-12 mb-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h5 class="card-title mb-2">Module {{ loop.index }}: {{ module.title }}</h5>
                <p class="card-text">{{ module.description }}</p>
              </div>
              <div>
                {% if user.is_subscribed or loop.index <= 5 %}
                  <a href="{{ url_for('module', course_name=course.title, id=module.id) }}" class="btn btn-primary">
                    Open
                  </a>
                {% else %}
                  <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#paypalModuleModal" data-module="{{ module.id }}">
                    Unlock Module
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Unlock Single Module Modal -->
  <div class="modal fade" id="paypalModuleModal" tabindex="-1" aria-labelledby="paypalModuleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title" id="paypalModuleModalLabel">Unlock Module</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <!-- Visible unlock message -->
          <p class="fw-bold text-warning mb-3">
            To unlock this module, please pay <strong>KES 500</strong> via PayPal.
          </p>
          <!-- PayPal Hosted Button directly below -->
          <div id="paypal-container-25ZB5B5M2Z9F8" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unlock All Modules Modal -->
  <div class="modal fade" id="paypalUnlockAllModal" tabindex="-1" aria-labelledby="paypalUnlockAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title" id="paypalUnlockAllModalLabel">Unlock All Modules</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <!-- Visible unlock message -->
          <p class="fw-bold text-warning mb-3">
            To unlock all modules in this course, please pay <strong>KES 2500</strong> via PayPal.
          </p>
          <!-- PayPal Hosted Button directly below -->
          <div id="paypal-container-E4QRSZMBN6Q4E" class="mt-2"></div>

          <!-- Subscription Option -->
          <hr>
          <p class="fw-bold text-info mb-3">Or subscribe for unlimited access:</p>
          <div id="paypal-subscription-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PayPal SDK Script -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&vault=true&intent=subscription&currency=USD"></script>
  <script>
    // Hosted button for single module
    paypal.HostedButtons({
      hostedButtonId: "25ZB5B5M2Z9F8"
    }).render("#paypal-container-25ZB5B5M2Z9F8");

    // Hosted button for full course
    paypal.HostedButtons({
      hostedButtonId: "E4QRSZMBN6Q4E"
    }).render("#paypal-container-E4QRSZMBN6Q4E");

    // Subscription button
    paypal.Buttons({
      createSubscription: function(data, actions) {
        return actions.subscription.create({
          plan_id: 'YOUR_PLAN_ID' // Replace with your PayPal subscription plan ID
        });
      },
      onApprove: function(data, actions) {
        alert('Subscription successful! ID: ' + data.subscriptionID);
      }
    }).render('#paypal-subscription-container');
  </script>
{% endblock %}
